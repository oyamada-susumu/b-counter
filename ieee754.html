<!DOCTYPE html>
<html lang="ja">
<head>
  <meta chaeset="utf-8">
  <title>IEEE754</title>
</head>
<body bgcolor="#ffffff">
<h3>32ビット浮動小数点数の内部表現</h3>
  <table id="LedTbl" border="1">
     <tr>
      <td>0</td>
      <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>
      <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>
      <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>
      <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>  <td>0</td>
    </tr>
    <tr>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
      <td><img src="LedOff.jpg" width="50"></td>
    </tr>
    <tr>
      <td><br><input type="button" id="pushButtonS" value="S"><br><br></td>
      <td><input type="button" id="pushButtonE8" value="E8"></td>
      <td><input type="button" id="pushButtonE7" value="E7"></td>
      <td><input type="button" id="pushButtonE6" value="E6"></td>
      <td><input type="button" id="pushButtonE5" value="E5"></td>
      <td><input type="button" id="pushButtonE4" value="E4"></td>
      <td><input type="button" id="pushButtonE3" value="E3"></td>
      <td><input type="button" id="pushButtonE2" value="E2"></td>
      <td><input type="button" id="pushButtonE1" value="E1"></td>
      <td><input type="button" id="pushButtonM1" value="M1"></td>
      <td><input type="button" id="pushButtonM2" value="M2"></td>
      <td><input type="button" id="pushButtonM3" value="M3"></td>
      <td><input type="button" id="pushButtonM4" value="M4"></td>
      <td><input type="button" id="pushButtonM5" value="M5"></td>
      <td><input type="button" id="pushButtonM6" value="M6"></td>
      <td><input type="button" id="pushButtonM7" value="M7"></td>
      <td><input type="button" id="pushButtonM8" value="M8"></td>
      <td><input type="button" id="pushButtonM9" value="M9"></td>
      <td><input type="button" id="pushButtonM10" value="M10"></td>
      <td><input type="button" id="pushButtonM11" value="M11"></td>
      <td><input type="button" id="pushButtonM12" value="M12"></td>
      <td><input type="button" id="pushButtonM13" value="M13"></td>
      <td><input type="button" id="pushButtonM14" value="M14"></td>
      <td><input type="button" id="pushButtonM15" value="M15"></td>
      <td><input type="button" id="pushButtonM16" value="M16"></td>
      <td><input type="button" id="pushButtonM17" value="M17"></td>
      <td><input type="button" id="pushButtonM18" value="M18"></td>
      <td><input type="button" id="pushButtonM19" value="M19"></td>
      <td><input type="button" id="pushButtonM20" value="M20"></td>
      <td><input type="button" id="pushButtonM21" value="M21"></td>
      <td><input type="button" id="pushButtonM22" value="M22"></td>
      <td><input type="button" id="pushButtonM23" value="M23"></td>
    </tr>
    <tr>
      <td>正0,負1</td>
      <td>128</td> <td>64</td> <td>32</td> <td>16</td> <td>8</td> <td>4</td> <td>2</td> <td>1</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>符号</td>
      <td colspan="8">指数部</td>
      <td colspan="23">仮数部</td>
    </tr>
  </table>
<br>
指数部
<input type="button" id="pushButtonRst"   value = "RESET">
<input type="button" id="pushButtonUp"    value = "UP">
<input type="button" id="pushButtonDown"  value = "DOWN">
10進数を入力してください
<input type="number" id="numberDEC"       value = "">
<input type="button" id="pushButtonDtoB"  value = "内部表現に変換する">
<input type="button" id="pushButtonBtoD"  value = "10進数で表示する">
<h3 id="hyouji">***1***</h3>
<h3 id="hyouji2">***2***</h3>
<h3 id="hyouji3">***3***</h3>
<h6 id="hyouji4">***4*** </h6>
<h6 id="hyouji10">***10***</h6>
<h6 id="hyouji9">***9***</h6>
<h6 id="hyouji11">***11***</h6>
<h6 id="hyouji45">***45***</h6>  
<h6 id="hyouji5">***5***</h6>
<h6 id="hyouji6">***6***</h6>
<h6 id="hyouji7">***7***</h6>
<h6 id="hyouji8">***8***</h6>
<script>
// SCRIPT START
//------------------------------------------------------------------------
// GLOBAL START
//------------------------------------------------------------------------
LedTbl.style.textAlign = "center";
LedTbl.style.verticalAlign = "middle"
//
let   fugo = 0;                                               // GLOBAL fugo 符号 0は+, 1は-
const fugoKanji=["＋","－"];                                  // 符号 表示用漢字
let   shisu = 0;                                              // GLOBAL shisu 指数
let   kasu=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];   // GLOBAL kasu  仮数                   
displaySign(fugo);                                      // 符号部を表示する
displayExponent(shisu);                                 // 指数部を表示する
displayMantissa(kasu);                                  // 仮数部を表示する
displaySyousu();
//------------------------------------------------------------------------
// GLOBAL END
//------------------------------------------------------------------------
function displaySyousu() {
  let M = [];
  let u = -1;
    for(let t = 0; t < 23; t++) {
      M[t] = "(" + String( 2**u ) + ") " ;
      u--; 
      hyouji5.innerHTML = M;
    }
  }
//-----------------------------
// 符号ボタンが押された時の関数
//-----------------------------
pushButtonS.onclick = function(){
  if(fugo == 1) {fugo = 0;} else {fugo = 1;}
  displaySign(fugo);
}
//---------------------------------------
//
// 2進数へ変換ボタンが押された時の関数
//
//---------------------------------------
pushButtonDtoB.onclick = function(){
  let x = numberDEC.value;                // 入力された文字を変数xに代入する
  let d = parseFloat(x, 10);              // 文字xを浮動小数点数dに変換する
  //---------------------
  // 符号を検出する
  //--------------------- 
  if(d < 0) {fugo = 1;} else {fugo = 0;}
  displaySign(fugo);                      // 符号を表示する
  //----------------------------------------------
  // 整数部（符号なし）を取り出す
  //----------------------------------------------
  let abs_d =         Math.abs(d);        // 絶対値をとる
  let abs_d_seisu =   Math.floor(abs_d);  // 切り捨てる
  //----------------------------------------------
  // 計算誤差がでるので、文字のまま小数部を取り出す
  //----------------------------------------------
  let xsp = x.split(".");                 // 小数点で区切って,xsp[0]整数部とxsp[1]小数部に分割する 
  if(xsp[1] == null) {xsp[1] = "0"};      // [1].[]などを[1].[0]に変換する。小数部は文字0となる。
  //-------------------------
  // 小数部を2進数に変換する
  //-------------------------
  let abs_d_syousu =  xsp[1];   /* 小数部は文字のまま処理することに注意! */
  let syousux = abs_d_syousu;   /* 小数部（文字）*/
  let syousuy = [];             /* 計算用 syousu y */
  let syousub = [];             /* 計算結果 ２進数小数部 syousu binary */
  hyouji4.innerHTML = "10進数"+abs_d + "の整数部は" + abs_d_seisu + ", 小数部は" + abs_d_syousu ;
  let carry=[];                 /* 繰り上がり carry bit */
  let syousu=[];                /* 元の小数部 */
  for(let i = 0; i < syousux.length; i++) {
    syousu[i] = syousux.charAt(i);            /* 10進数小数部文字を１けたずつ配列に格納する */
  }
  for(let i = 0; i < syousux.length; i++) {
      syousuy[i] = syousu[i];                 /* 10進数小数部　計算結果用 */
      carry[i] = 0;                           /* 10進数小数部　繰り上がり用 */
  }
  carry[syousux.length] = 0;                  /* 最下位の繰り上がりは０なので、１桁下の（最下位＋１）lengthに０をセットしておく */
  hyouji6.innerHTML= syousu;
  //--------------------------------------------------------
  // 筆算方式の算譜(ここは10進数で計算をしていることに注意！)
  // 計算結果の2進数小数部はsyousubに格納される
  //-------------------------------------------------------
  for(let j = 0; j < 100; j++) {                      // ２進数で少数点以下100桁まで求める j=0から99         
    for(let i = syousux.length - 1; i > -1; i--) {    // 小数最下位から１桁ずつ２をかけていく（＊１）
      syousuy[i] = syousuy[i] * 2;                    // 小数部の１桁を２倍する 
      if(syousuy[i] > 9) {                            // 繰り上がりの計算
        carry[i] = 1;                                 // 9より大きければ,繰り上がりは1・・・(注１)を見よ
        syousuy[i] = syousuy[i] - 10;                 // 10を引いて1桁にする
      }
      syousuy[i] = syousuy[i] + carry[i+1];           // 下位からの繰り上がりをたす
    }
    syousub[j]=carry[0];                              // 小数点以下第一位の繰り上げ＝（整数部1の位)を2進数小数点以下の各位の計算結果として保存する
    for(let k = 0; k < syousux.length; k++) {         // 繰り上げをすべて0にセットして、（＊１）へ
      carry[k]=0;
    }
  }
  hyouji9.innerHTML = "小数部(2進数)="+syousub;
  displayMantissa(syousub);
  //-------------------------------------------------------------------------
  // (注１) 10進数整数１桁の2の掛け算, つまり,
  // {x*2,xは整数 | 0 <= x <= 9} は {0,2,4,6,8,10,12,14,16,18}がすべてである。
  // 繰り上がりは1しかないので, 10を引けば1桁になり, 計算している桁が確定する。
  //-------------------------------------------------------------------------
  //--------------------------------
  //  10進数整数部を2進数に変換する
  //--------------------------------
  let seisu = abs_d_seisu;  // 計算用 整数部の絶対値をいれておく
  let seisub = [];          // ２進数整数部 最下位から最上位へ格納用
  let seisuc = [];          // ２進数整数部 最上位から最下位へ表示用
  let j = 0;
  seisub[0] = 0;                     // 整数部0のときは何もしないので、整数部1桁目(添字0)に0を代入しておく  
  while(seisu >= 1) {                // 10進数を商が１になるまで割る
    seisub[j] = seisu % 2            // ２で割ったあまりが２進数の各位になる
    seisu = Math.floor(seisu / 2);   // 商を求める
    j++;
    }
  for(let k = 0; k < seisub.length; k++){        // 整数部を表示用に順番を逆転させる
    seisuc[k] = seisub[seisub.length - k - 1];
    }
  hyouji10.innerHTML = "整数部(２進数)=" + seisuc;
  //---------------------------------------------------------------------------------
  // 整数部と小数部を連結させ,仮数部と指数部を得る
  //---------------------------------------------------------------------------------
  let bnum = seisuc.concat(syousub);  // 整数部seisucと少数部syousubを連結して配列bnumとする
  hyouji11.innerHTML = "整数部+小数部(２進数)=" + bnum;
  //-----------------------------------------------------------------------------------
  // 整数部が0でない場合は,
  // 6.0125なら 110(2)と.001(2) ----> 110.001(2)
  // 1.xxxに変換する             ----> 1.1001×2^2   2は整数部110の長さ3-1
  // bnum = [1,1,0,0,0,1] となっている。
  // 小数点の位置：(整数部の長さ-1)だけ小数点を左にシフトさせる。
  // 指数部＝(整数部の長さ-1)となる。小数点のシフト桁数分
  // 仮数部：先頭の1（配列の0番目に入っている）は省略するので、
  //         配列の添え字1から順番に仮数部の添え字0からセットしていく。
  //-----------------------------------------------------------------------------------
  // 整数部が0の場合は,
  // 0.015625 --> 0.125+0.03125 --> 1/8+1/32 --> 0(2)と.00101(2) --> 0.00101(2)
  // 1.xxxに変換する --> 1.01×2^(-3) -->(-3)は-1*(小数部最初の1の添え字2+1)
  // bnum = [0,0,0,1,0,1] となっている。
  // 小数点の位置：(小数部の先頭からの0の数)だけ小数点を右にシフトさせる。
  // 指数部＝(-1)×(右シフトの回数)となる。
  // 仮数部：配列bnumの先頭からはじめての1の前の3個の0を取り去り bnum = [1,0,1] とする。
  // 仮数部：先頭の1（配列の0番目に入っている）は省略するので、
  //         配列の添え字1から順番に仮数部の添え字0からセットしていく。
  //------------------------------------------------------------------------------------
  kasubu=[]
  if(abs_d_seisu != 0) {
    shisu = seisuc.length - 1;
  }
  if(abs_d_seisu == 0 ) {
    shisu = 0;
    let t = bnum.length;
    for(let j = 1; j < t; j++) {
      if(bnum[j] == 1) {
        for(let k = 0; k < j; k++) {
          let returnVal = bnum.shift();
          bnum.push(0);
          shisu = shisu - 1;
        }
        break;
      }
    }
  }
  for(let i = 0; i < bnum.length - 1; i++) {
    kasubu[i] = bnum[i+1];
  }
  //----------------------------------------
  // 0のとき, 32ビットすべてが0, 指数部も0
  // 0でないとき, 指数部に127の下駄をはかせる
  //----------------------------------------
  if(abs_d == 0) {
    shisu = 0;
    } else {
      shisu = shisu + 127;
    }
  //----------------------------------------
  hyouji45.innerHTML = "bnum=" + bnum;
  displayExponent(shisu);
  displayMantissa(kasubu);
}
//---------------------------
// 各ボタンが押された時の関数
//---------------------------
pushButtonE1.onclick = function(){if(D2BX(shisu,0)==1){shisu=shisu-1;}else{shisu=shisu+1;}displayExponent(shisu);}
pushButtonE2.onclick = function(){if(D2BX(shisu,1)==1){shisu=shisu-2;}else{shisu=shisu+2;}displayExponent(shisu);}
pushButtonE3.onclick = function(){if(D2BX(shisu,2)==1){shisu=shisu-4;}else{shisu=shisu+4;}displayExponent(shisu);}
pushButtonE4.onclick = function(){if(D2BX(shisu,3)==1){shisu=shisu-8;}else{shisu=shisu+8;}displayExponent(shisu);}
pushButtonE5.onclick = function(){if(D2BX(shisu,4)==1){shisu=shisu-16;}else{shisu=shisu+16;}displayExponent(shisu);}
pushButtonE6.onclick = function(){if(D2BX(shisu,5)==1){shisu=shisu-32;}else{shisu=shisu+32;}displayExponent(shisu);}
pushButtonE7.onclick = function(){if(D2BX(shisu,6)==1){shisu=shisu-64;}else{shisu=shisu+64;}displayExponent(shisu);}
pushButtonE8.onclick = function(){if(D2BX(shisu,7)==1){shisu=shisu-128;}else{shisu=shisu+128;}displayExponent(shisu);}
pushButtonRst.onclick = function(){shisu=0;displayExponent(shisu);}
pushButtonUp.onclick = function(){shisu=shisu+1;if(shisu>255){shisu=0;}displayExponent(shisu);}
pushButtonDown.onclick = function(){shisu=shisu-1;if(shisu<0){shisu=255;}displayExponent(shisu);}
pushButtonM1.onclick = function(){if(kasu[0] == 1){kasu[0] = 0;}else{kasu[0] = 1;}displayMantissa(kasu); }
pushButtonM2.onclick = function(){if(kasu[1] == 1){kasu[1] = 0;}else{kasu[1] = 1;}displayMantissa(kasu); }
pushButtonM3.onclick = function(){if(kasu[2] == 1){kasu[2] = 0;}else{kasu[2] = 1;}displayMantissa(kasu); }
pushButtonM4.onclick = function(){if(kasu[3] == 1){kasu[3] = 0;}else{kasu[3] = 1;}displayMantissa(kasu); }
pushButtonM5.onclick = function(){if(kasu[4] == 1){kasu[4] = 0;}else{kasu[4] = 1;}displayMantissa(kasu); }
pushButtonM6.onclick = function(){if(kasu[5] == 1){kasu[5] = 0;}else{kasu[5] = 1;}displayMantissa(kasu); }
pushButtonM7.onclick = function(){if(kasu[6] == 1){kasu[6] = 0;}else{kasu[6] = 1;}displayMantissa(kasu); }
pushButtonM8.onclick = function(){if(kasu[7] == 1){kasu[7] = 0;}else{kasu[7] = 1;}displayMantissa(kasu); }
pushButtonM9.onclick = function(){if(kasu[8] == 1){kasu[8] = 0;}else{kasu[8] = 1;}displayMantissa(kasu); }
pushButtonM10.onclick = function(){if(kasu[9] == 1){kasu[9] = 0;}else{kasu[9] = 1;}displayMantissa(kasu); }
pushButtonM11.onclick = function(){if(kasu[10] == 1){kasu[10] = 0;}else{kasu[10] = 1;}displayMantissa(kasu); }
pushButtonM12.onclick = function(){if(kasu[11] == 1){kasu[11] = 0;}else{kasu[11] = 1;}displayMantissa(kasu); }
pushButtonM13.onclick = function(){if(kasu[12] == 1){kasu[12] = 0;}else{kasu[12] = 1;}displayMantissa(kasu); }
pushButtonM14.onclick = function(){if(kasu[13] == 1){kasu[13] = 0;}else{kasu[13] = 1;}displayMantissa(kasu); }
pushButtonM15.onclick = function(){if(kasu[14] == 1){kasu[14] = 0;}else{kasu[14] = 1;}displayMantissa(kasu); }
pushButtonM16.onclick = function(){if(kasu[15] == 1){kasu[15] = 0;}else{kasu[15] = 1;}displayMantissa(kasu); }
pushButtonM17.onclick = function(){if(kasu[16] == 1){kasu[16] = 0;}else{kasu[16] = 1;}displayMantissa(kasu); }
pushButtonM18.onclick = function(){if(kasu[17] == 1){kasu[17] = 0;}else{kasu[17] = 1;}displayMantissa(kasu); }
pushButtonM19.onclick = function(){if(kasu[18] == 1){kasu[18] = 0;}else{kasu[18] = 1;}displayMantissa(kasu); }
pushButtonM20.onclick = function(){if(kasu[19] == 1){kasu[19] = 0;}else{kasu[19] = 1;}displayMantissa(kasu); }
pushButtonM21.onclick = function(){if(kasu[20] == 1){kasu[20] = 0;}else{kasu[20] = 1;}displayMantissa(kasu); }
pushButtonM22.onclick = function(){if(kasu[21] == 1){kasu[21] = 0;}else{kasu[21] = 1;}displayMantissa(kasu); }
pushButtonM23.onclick = function(){if(kasu[22] == 1){kasu[22] = 0;}else{kasu[22] = 1;}displayMantissa(kasu); }
//-----------------------------
//　符号部（１桁）を表示する関数
//-----------------------------
function displaySign(x){
  hyouji.innerHTML = "符号部Ｓ＝" + String(x)+ "は [" + fugoKanji[x] + "] を表す。"
  LedTbl.rows[0].cells[0].innerHTML=x;
  if (x==1){
    LedTbl.rows[1].cells[0].innerHTML='<img src="LedOn.jpg" width="50">';
    }else{
    LedTbl.rows[1].cells[0].innerHTML='<img src="LedOff.jpg" width="50">';
    } 
}
//----------------------------
// 指数部（８桁）を表示する関数
// 添え字0から7の8桁を表示する
//----------------------------
function displayExponent(x){
  D=decimal_to_binary(x);
  displayLed(D);
  TX="";
  for(j=0; j<8; j++){
    TX=TX+D[j]
    }
  hyouji2.innerHTML = "指数部Ｅ＝" + String(TX) + " は10進数で" + String(x) +
  ",よって" + String(x) + "-" + String(127) + "=" + String(x-127) +
  ",つまり [2の"+String(x-127)+"乗] を表す。指数部に符号はない。本当の値に127を足して（下駄をはかせて）保存しておく。使うときは127を引いてから使う。こうするとマイナス乗も表現できる。";
}
//------------------------------
// 仮数部（２３桁）を表示する関数
// 添え字0から22の23桁を表示する
//------------------------------
function displayMantissa(K){
  TX="";
  for(j=0; j<23; j++){
    LedTbl.rows[0].cells[j+9].innerHTML=K[j];
    TX=TX+K[j];
    if(K[j]==1){
      LedTbl.rows[1].cells[j+9].innerHTML='<img src="LedOn.jpg" width="50">';
      }else{
      LedTbl.rows[1].cells[j+9].innerHTML='<img src="LedOff.jpg" width="50">'; 
      }
    }
  hyouji3.innerHTML = "仮数部Ｍ=" + TX + " は２進数で, [１." + TX +"] を表す。2進数の最上位は必ず1になるので,1ビット「けちって」省略している。";
}
//---------------------------------
// 10進数を2進数(8桁)に変換する関数
//---------------------------------
function decimal_to_binary(x){
  a=[];
  b=[];
  for(j=0; j<8; j=j+1){
    a[j]=x%2
    x = Math.floor(x/2);
    }
  for(k=0; k<8; k=k+1){
    b[7-k]=a[k];
    }
  return b;
}
//---------------------------------
// 指数部（８桁）のLEDを表示する関数
//---------------------------------
function displayLed(c){
  r=1; n=0;
  for(k=0; k<8; k++){
    LedTbl.rows[n].cells[k+1].innerHTML= c[k] ;
    if (c[k]==1){
      LedTbl.rows[r].cells[k+1].innerHTML='<img src="LedOn.jpg" width="50">';
      }else{
      LedTbl.rows[r].cells[k+1].innerHTML='<img src="LedOff.jpg" width="50">';
      } 
    }
}
//---------------------------------
// 10進数を2進数(8桁)に変換する関数
//---------------------------------
function D2BX(x,n) {
  a=[];
  for(j=0; j<8; j=j+1){
    a[j]=x%2
    x = Math.floor(x/2);
    }
  return a[n];
}
//=============
// SCRIPT END
//=============
</script>
</body>
</html>